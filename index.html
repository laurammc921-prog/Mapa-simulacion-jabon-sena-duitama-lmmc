<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa de Distribución en Duitama</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 600px; width: 100%; }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 20px;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      z-index: 1000;
      width: 250px;
      min-height: 100px;
      font-size: 12px;
    }
    .legend h4 { margin: 0 0 8px; font-size: 14px; }
    .leaflet-routing-container {
      display: none;
      position: absolute;
      right: 10px;
      width: 300px;
      background: white;
      border: 1px solid #ccc;
      z-index: 999;
    }
    .leaflet-routing-container .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      cursor: pointer;
      padding: 5px;
      z-index: 1001;
    }
    .como-llegar {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      z-index: 1000;
      width: 300px;
    }
    .como-llegar.collapsed .route-list { display: none; }
    .como-llegar .toggle-btn {
      padding: 5px;
      cursor: pointer;
      width: 100%;
      text-align: left;
      background: #f0f0f0;
      border: none;
      font-size: 14px;
    }
    .como-llegar h4 { margin: 0 0 10px; }
    .como-llegar button { margin: 2px; padding: 5px; cursor: pointer; width: 80px; }
    .como-llegar div.route-list div { margin-bottom: 5px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script>
    // Inicializar mapa
    const map = L.map('map').setView([5.825, -73.034], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Bodega
    const warehouse = { lat: 5.825, lng: -73.034 };

    // Tiendas
    const stores = [
      { id: "S1", lat: 5.8280, lng: -73.0380, demand: 33 },
      { id: "S2", lat: 5.8240, lng: -73.0320, demand: 33 },
      { id: "S3", lat: 5.8180, lng: -73.0430, demand: 33 },
      { id: "S4", lat: 5.8230, lng: -73.0480, demand: 33 },
      { id: "S5", lat: 5.8140, lng: -73.0540, demand: 34 },
      { id: "S6", lat: 5.8100, lng: -73.0590, demand: 34 },
      { id: "S7", lat: 5.8300, lng: -73.0590, demand: 33 },
      { id: "S8", lat: 5.8330, lng: -73.0630, demand: 33 },
      { id: "S9", lat: 5.8390, lng: -73.0700, demand: 33 },
      { id: "S10", lat: 5.8420, lng: -73.0750, demand: 33 },
      { id: "S11", lat: 5.8480, lng: -73.0820, demand: 34 },
      { id: "S12", lat: 5.8510, lng: -73.0890, demand: 34 },
      { id: "S13", lat: 5.7830, lng: -73.0440, demand: 33 },
      { id: "S14", lat: 5.7800, lng: -73.0490, demand: 33 },
      { id: "S15", lat: 5.7740, lng: -73.0550, demand: 33 },
      { id: "S16", lat: 5.7700, lng: -73.0600, demand: 33 },
      { id: "S17", lat: 5.7640, lng: -73.0660, demand: 34 },
      { id: "S18", lat: 5.7600, lng: -73.0710, demand: 34 },
      { id: "S19", lat: 5.8400, lng: -73.0330, demand: 33 },
      { id: "S20", lat: 5.8430, lng: -73.0290, demand: 33 },
      { id: "S21", lat: 5.8490, lng: -73.0360, demand: 33 },
      { id: "S22", lat: 5.8520, lng: -73.0400, demand: 33 },
      { id: "S23", lat: 5.8580, lng: -73.0450, demand: 34 },
      { id: "S24", lat: 5.8610, lng: -73.0500, demand: 34 },
      { id: "S25", lat: 5.8490, lng: -73.0230, demand: 33 },
      { id: "S26", lat: 5.8540, lng: -73.0180, demand: 33 },
      { id: "S27", lat: 5.8610, lng: -73.0130, demand: 33 },
      { id: "S28", lat: 5.8670, lng: -73.0080, demand: 33 },
      { id: "S29", lat: 5.8740, lng: -73.0040, demand: 34 },
      { id: "S30", lat: 5.8810, lng: -73.0010, demand: 34 }
    ];

    // Formatter personalizado: distancias + calles (sin tiempos)
    var CustomFormatter = L.Routing.Formatter.extend({
      formatInstruction: function(instr) {
        var distance = this.formatDistance(instr.distance);
        var instruction = this._getInstructionTemplate(instr);
        return distance + ' - ' + instruction;
      },
      _getInstructionTemplate: function(instr) {
        let road = instr.road ? " en " + instr.road : "";
        switch (instr.type) {
          case 'Straight': return 'Continuar recto' + road;
          case 'Right': return 'Girar a la derecha' + road;
          case 'Left': return 'Girar a la izquierda' + road;
          case 'SlightRight': return 'Giro leve a la derecha' + road;
          case 'SlightLeft': return 'Giro leve a la izquierda' + road;
          case 'SharpRight': return 'Giro fuerte a la derecha' + road;
          case 'SharpLeft': return 'Giro fuerte a la izquierda' + road;
          case 'Roundabout': return 'Tomar la salida ' + instr.exit + ' en la rotonda' + road;
          case 'DestinationReached': return 'Destino alcanzado' + road;
          default: return 'Seguir' + road;
        }
      },
      formatTime: function() { return ""; }, // eliminar tiempos
      formatSummary: function(route) {
        return this.formatDistance(route.summary.totalDistance); // solo distancia
      }
    });

    // Rutas
    const routes = [
      { stores: ["S1","S2","S3","S4","S5","S6"], color: "red" },
      { stores: ["S7","S8","S9","S10","S11","S12"], color: "blue" },
      { stores: ["S13","S14","S15","S16","S17","S18"], color: "green" },
      { stores: ["S19","S20","S21","S22","S23","S24"], color: "orange" },
      { stores: ["S25","S26","S27","S28","S29","S30"], color: "purple" }
    ];

    const routeLayers = {};
    const routePanels = {};

    routes.forEach((route, index) => {
      const waypoints = [
        L.latLng(warehouse.lat, warehouse.lng),
        ...route.stores.map(id => {
          const store = stores.find(s => s.id === id);
          return L.latLng(store.lat, store.lng);
        }),
        L.latLng(warehouse.lat, warehouse.lng)
      ];

      const routeControl = L.Routing.control({
        waypoints: waypoints,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        lineOptions: { styles: [{ color: route.color, weight: 4 }] },
        formatter: new CustomFormatter(),
        createMarker: (i, wp, n) => {
          if (i === 0 || i === n - 1) return null;
          const store = stores.find(s => s.lat === wp.latLng.lat && s.lng === wp.latLng.lng);
          return L.marker(wp.latLng).bindPopup(
            `Tienda: ${store.id}<br>Demanda: ${store.demand} unidades<br>Secuencia: ${i}`
          );
        },
        show: true
      }).addTo(map);

      setTimeout(() => {
        const panel = routeControl.getContainer();
        panel.id = `route-panel-${index + 1}`;
        const closeBtn = L.DomUtil.create('div', 'close-btn');
        closeBtn.innerHTML = 'X';
        closeBtn.onclick = function() { panel.style.display = 'none'; };
        panel.appendChild(closeBtn);
        routePanels[`Ruta ${index + 1}`] = panel;
      }, 1000);

      routeLayers[`Ruta ${index + 1}`] = routeControl;
    });

    // Control de capas
    L.control.layers({}, routeLayers, { position: 'topright', collapsed: true }).addTo(map);

    // Leyenda
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<h4>Leyenda</h4>';
      routes.forEach((route, index) => {
        const totalDemand = route.stores.reduce((sum, id) => {
          const store = stores.find(s => s.id === id);
          return sum + store.demand;
        }, 0);
        div.innerHTML += `<div><span style="color:${route.color};">■</span> Ruta ${index+1}: ${route.stores.length} tiendas, ${totalDemand} unidades</div>`;
      });
      return div;
    };
    legend.addTo(map);

    // Panel "Cómo Llegar"
    const comoLlegar = L.control({ position: 'topright' });
    comoLlegar.onAdd = function () {
      const div = L.DomUtil.create('div', 'como-llegar collapsed');
      div.innerHTML = `
        <button class="toggle-btn">Cómo Llegar ▼</button>
        <div class="route-list">
          <h4>Cómo Llegar</h4>
          ${routes.map((route, index) => `
            <div>
              Ruta ${index + 1}
              <button onclick="showPanel('route-panel-${index + 1}')">Mostrar</button>
              <button onclick="hidePanel('route-panel-${index + 1}')">Ocultar</button>
            </div>
          `).join('')}
        </div>`;
      const toggleBtn = div.querySelector('.toggle-btn');
      toggleBtn.onclick = function() {
        const isCollapsed = div.classList.contains('collapsed');
        div.classList.toggle('collapsed', !isCollapsed);
        toggleBtn.innerHTML = isCollapsed ? 'Cómo Llegar ▼' : 'Cómo Llegar ▲';
        Object.values(routePanels).forEach(panel => {
          if (panel.style.display !== 'none') {
            panel.style.top = `${div.offsetHeight + 20}px`;
          }
        });
      };
      return div;
    };
    comoLlegar.addTo(map);

    // Funciones para mostrar/ocultar paneles
    window.showPanel = function(panelId) {
      Object.values(routePanels).forEach(panel => { panel.style.display = 'none'; });
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.style.top = `140px`; // debajo del panel "Cómo Llegar"
        panel.style.display = 'block';
      }
    };
    window.hidePanel = function(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) panel.style.display = 'none';
    };
  </script>
</body>
</html>
